<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Define an action for opening the view -->
    <record id="cdr_action" model="ir.actions.act_window">
        <field name="name">Call Logs</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">cdr.log</field>
        <field name="view_mode">tree,form,kanban,graph</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Here You Will Find All Calls Logs
            </p>
        </field>
    </record>

    <!-- Define an action for updating logs -->
    <record id="action_update_logs" model="ir.actions.server">
        <field name="name">Update Logs</field>
        <field name="type">ir.actions.server</field>
        <field name="model_id" ref="model_cdr_log"/>
        <field name="state">code</field>
        <field name="code">action = model.update_logs(); action['new'] = 'current'; action</field>                                            
    </record>

    <!-- Define a form view for displaying CDR Logs -->
    <record id="view_cdr_log_form" model="ir.ui.view">
        <field name="name">cdr.log.form</field>
        <field name="model">cdr.log</field>
        <field name="arch" type="xml">
            <form string="CDR Log" create="false" edit="false">
                <sheet>
                    <group>
                        <field name="timestamp"/>
                        <field name="source"/>
                        <field name="destination"/>
                        <field name="status"/>
                        <field name="duration"/>
                        <field name="call_recording" invisible="1"/> <!-- Hide the binary field -->
                        <field name="file_path" invisible="1"/> <!-- Hide the file_path field -->
                        <button name="convert_recording" string="Generate Recording" type="object" class="oe_highlight" attrs="{'invisible': [('call_recording', '=', False)]}"/> <!-- Show button only if call_recording exists -->
                    </group>
                    <group>
                        <field name="audio_player_html" widget='html' nolabel="1" attrs="{'invisible': [('file_path', '=', False)]}"/> <!-- Show Player only if path exists -->
                        <button name="delete_temp_file" string="Delete Recording" type="object" class="oe_highlight" attrs="{'invisible': [('file_path', '=', False)]}"/> <!-- Show delete button only if path exists -->
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Define a tree view for displaying CDR Logs -->
    <record id="view_cdr_log_tree" model="ir.ui.view">
        <field name="name">cdr.log.tree</field>
        <field name="model">cdr.log</field>
        <field name="arch" type="xml">
            <tree>
                <field name="timestamp"/>
                <field name="source"/>
                <field name="destination"/>
                <field name="status"/>
                <field name="duration"/>
            </tree>
        </field>
    </record>

    <!-- Define a graph view for displaying CDR Logs -->
    <record id="view_total_calls_graph" model="ir.ui.view">
        <field name="name">total.calls.graph</field>
        <field name="model">cdr.log</field>
        <field name="arch" type="xml">
            <graph string="Total Calls" type="bar">
                <field name="source" type="row"/>
                <field name="id" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Define a search view for the model -->
    <record id="view_cdr_log_search" model="ir.ui.view">
        <field name="name">cdr.log.search</field>
        <field name="model">cdr.log</field>
        <field name="type">search</field>
        <field name="arch" type="xml">
            <!-- Define the search view layout -->
            <search>
                <!-- Define filters and groupings -->
                <field name="timestamp" string="Timestamp"/>
                <field name="source"/>
                <field name="destination"/>
                <field name="status" string="Call Status"/>

                <separator/>

                <!-- Filters based on Call Status -->
                <filter string="Answered" name="answered" domain="[('status', '=', 'ANSWERED')]"/>
                <filter string="No Answer" name="unaswered" domain="[('status', '=', 'NO ANSWER')]"/>
                <filter string="Incoming Calls" name="in_c" domain="[('length', '=', '3'), ('source', 'ilike', 'out')]"/>
                <filter string="Outgoing Calls" name="out_c" domain="[('length', '=', '8')]"/>

                <group expand="1" string="Group By">
                    <filter string="Source" name="source" context="{'group_by': 'source'}"/>
                    <filter string="Destination" name="destination" context="{'group_by': 'destination'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Define a menu item to access the CDR Log -->
    <menuitem id="cdr_root" name="Call Detail Records"  parent="asterisk_root" sequence="5"/>
    <menuitem id="cdr_acc"  name="Call Details"  parent="cdr_root" action="cdr_action" sequence="6" />
    <menuitem id="upd_cdr" name ="Update CDR" action="action_update_logs" parent="cdr_root" sequence="5"/>
</odoo>
